---
import Button from "./Button.astro";
---

<script>
	const darkModeToggle: HTMLElement | null = document.querySelector("#dark-mode-toggle");
	const metaThemeColorTag = document.querySelector('meta[name="theme-color"]');

	const isDarkMode = (): boolean => {
		const theme = localStorage.getItem("theme");
		return theme ? theme === "dark" : window.matchMedia("(prefers-color-scheme: dark)").matches;
	};

	const changeHtmlTheme = (isDark: boolean) => {
		// change html class
		isDark
			? document.documentElement.classList.add("dark")
			: document.documentElement.classList.remove("dark");

		// update theme-color meta tag
		metaThemeColorTag?.setAttribute("content", isDark ? "#000000" : "#eaebe6");
	};

	const calculateEndRadius = (): Number => {
		if (!darkModeToggle) return 0;

		const rect = darkModeToggle.getBoundingClientRect();
		const x = rect.left + rect.width / 2;
		const y = rect.top + rect.height / 2;

		return Math.hypot(Math.max(x, innerWidth - x), Math.max(y, innerHeight - y));
	};

	const changeBgClipRadius = (isDark: boolean) => {
		if (!darkModeToggle) return;

		const endRadius = isDark ? 0 : calculateEndRadius();

		const rect = darkModeToggle.getBoundingClientRect();
		const x = rect.left + rect.width / 2;
		const y = rect.top + rect.height / 2;

		document.documentElement.style.setProperty("--clip-x", `${x}px`);
		document.documentElement.style.setProperty("--clip-y", `${y}px`);
		document.documentElement.style.setProperty("--clip-radius", `${endRadius}px`);
	};

	const toggleDarkMode = () => {
		const isDark = isDarkMode();
		changeHtmlTheme(!isDark);
		changeBgClipRadius(!isDark);
		localStorage.setItem("theme", isDark ? "light" : "dark");
	};

	// setup dark mode toggle handlers
	darkModeToggle?.addEventListener("click", toggleDarkMode);

	// recalculate clip radius on resize
	window.addEventListener("resize", () => changeBgClipRadius(isDarkMode()));

	// change dark mode on mount
	const isDark = isDarkMode();
	changeHtmlTheme(isDark);
	changeBgClipRadius(isDark);
</script>

<Button id="dark-mode-toggle" title="Toggle color scheme" class="p-2">
	<span
		class="max-w-1.2em max-h-1.2em overflow-hidden
		       children:(block transition-translate-300 transition-opacity-300 ease-out dark:translate-y-[-100%])"
	>
		<span class="i-ri-sun-line"></span>
		<span class="i-ri-moon-line"> </span>
	</span>
</Button>

<style>
	html {
		--clip-radius: 0px;
		--clip-x: 0px;
		--clip-y: 0px;
	}

	html::before {
		content: "";
		width: 100%;
		height: 100%;
		top: 0;
		left: 0;
		position: fixed;
		z-index: -999;
		background-color: rgb(var(--bg-color-light));

		clip-path: circle(var(--clip-radius) at var(--clip-x) var(--clip-y));
		transition: clip-path 300ms ease-out;
	}

	@media (prefers-reduced-motion: reduce) {
		html::before {
			transition: none;
		}
	}
</style>
