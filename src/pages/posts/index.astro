---
import { getCollection } from "astro:content";
import Layout from "@layouts/Layout.astro";
import PostLink from "@components/PostLink.astro";

const posts = await getCollection("posts");
const sortedPosts = posts.sort(
	(a, b) => new Date(b.data.published).valueOf() - new Date(a.data.published).valueOf(),
);
const postsWithMinutesRead = sortedPosts.map((post) => {
	return {
		...post,
		data: {
			...post.data,
			// @ts-expect-error frontmatter.minutesRead is added by remarkReadingTime plugin in astro.config.mjs
			minutesRead: post.rendered?.metadata?.frontmatter?.minutesRead || 0,
		},
	};
});
const groupedPosts = Object.groupBy(postsWithMinutesRead, (p) =>
	new Date(p.data.published).getFullYear(),
);
---

<Layout title="Blog">
	<h1 class="font-bold text-3xl">Blog</h1>

	<br />

	{
		Object.entries(groupedPosts).map(([year, posts]) => (
			<>
				<h2 class="text-3xl font-bold">{year}</h2>
				<br />
				<ul class="flex flex-col gap-4">
					{posts?.map(({ data, id }) => (
						<PostLink slug={id} {...data} />
					))}
				</ul>
			</>
		))
	}
</Layout>
